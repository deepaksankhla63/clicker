#!/bin/bash

set -e

echo "[1] Verificando espacio disponible..."
df -h

echo "[2] Creando carpeta de datos para Docker..."
sudo mkdir -p /tmp/docker-data

echo "[3] Configurando Docker Root Dir..."
sudo bash -c 'cat > /etc/docker/daemon.json <<EOF
{
  "data-root": "/tmp/docker-data"
}
EOF'

echo "[4] Reinicia manualmente tu Codespace después de este script."
echo "   Si no reinicias, Docker seguirá usando el directorio viejo."

echo "[5] Creando archivo .env (con tus valores fijos)..."
cat > .env <<EOF
WINDOWS_USERNAME=rootdeepak
WINDOWS_PASSWORD=admin
GITHUB_USER=rootdeepak
EOF

echo "[6] Agregando .env a .gitignore..."
echo ".env" >> .gitignore

echo "[7] Creando windows10.yml SIN auto-restart..."
cat > windows10.yml <<'EOF'
# Antes de ejecutar docker-compose up, ejecuta:
# bash check_github_follow.sh || exit 1
# Si no sigues a https://github.com/jephersonRD, el entorno no se iniciará.
services:
  windows:
    image: dockurr/windows
    container_name: windows
    environment:
      VERSION: "10"
      USERNAME: ${WINDOWS_USERNAME}
      PASSWORD: ${WINDOWS_PASSWORD}
      RAM_SIZE: "10G"
      CPU_CORES: "4"
    cap_add:
      - NET_ADMIN
    ports:
      - "8006:8006"
      - "3389:3389/tcp"
    volumes:
      - /tmp/docker-data:/mnt/disco1
      - windows-data:/mnt/windows-data
    devices:
      - "/dev/kvm:/dev/kvm"
      - "/dev/net/tun:/dev/net/tun"
    stop_grace_period: 2m
    restart: "no"   # <<< NO auto-restart
EOF

echo "[8] Creando check_github_follow.sh..."
cat > check_github_follow.sh <<'EOF'
#!/bin/bash

if [ -z "$GITHUB_USER" ]; then
  echo "ERROR: GITHUB_USER no está definido en .env"
  exit 1
fi

TARGET_USER="jephersonRD"

echo "Verificando si sigues a $TARGET_USER..."

if curl -s https://api.github.com/users/$GITHUB_USER/following/$TARGET_USER | grep -q "following"; then
  echo "OK: Ya sigues a $TARGET_USER"
  exit 0
else
  echo "NO SIGUES a $TARGET_USER"
  exit 1
fi
EOF

chmod +x check_github_follow.sh

echo ""
echo "----------------------------------------"
echo "SETUP COMPLETO"
echo "Reinicia tu Codespace."
echo "Luego ejecuta:"
echo "bash check_github_follow.sh && docker-compose -f windows10.yml up"
echo "----------------------------------------"
